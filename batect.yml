containers:
  build-env:
    image: node:11.4.0
    volumes:
      - local: .
        container: /app
        options: cached
    working_directory: /app
    environment:
      PORT: 8352

  terraform-env:
    build_directory: ./infra
    volumes:
      - local: ./infra
        container: /app
        options: cached
    working_directory: /app
    environment:
      BUCKET_NAME: terraform-bucket
      TF_VAR_aws_access_key: ${AWS_ACCESS_KEY_ID}
      TF_VAR_aws_secret_key: ${AWS_SECRET_ACCESS_KEY}

tasks:
  setup:
    run:
      container: build-env
      command: scripts/set_the_bloody_fa_pro_key.sh
      environment:
        FONTAWESOME_NPM_AUTH_TOKEN: ${FONTAWESOME_NPM_AUTH_TOKEN}

  install:
    description: Download dependencies need to run the application and tests.
    run:
      container: build-env
      command: scripts/install.sh
    prerequisites:
      - setup

  build:
    description: Compiles and minifies for production
    run:
      container: build-env
      command: yarn run build

  init-terraform:
    description: Initialise terraform
    run:
      container: terraform-env
      command: terraform init

  plan-terraform:
    description: Initialise and plan terraform
    run:
      container: terraform-env
      command: terraform plan -out=tfplan
    prerequisites:
      - init-terraform

  validate-terraform:
    description: Validate terraform script
    run:
      container: terraform-env
      command: terraform validate
    prerequisites:
      - init-terraform

  apply-terraform:
    description: Apply terraform
    run:
      container: terraform-env
      command: terraform apply "tfplan"
